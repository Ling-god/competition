import os
import random
import numpy as np
import cv2
from PIL import Image, ImageDraw, ImageFont, ImageEnhance

FONT_PATH = "C:/Windows/Fonts/simsun.ttc"   # å®‹ä½“è·¯å¾„
SAVE_ROOT = "dataset"
IMG_SIZE = 64
TRAIN_PER_CLASS = 3000
VAL_PER_CLASS = 500


def make_dirs():
    for split in ["train", "val"]:
        for i in range(10):
            path = os.path.join(SAVE_ROOT, split, str(i))
            os.makedirs(path, exist_ok=True)


def add_noise(img_np):
    noise = np.random.randint(0, 30, img_np.shape, dtype=np.uint8)
    img_np = cv2.add(img_np, noise)
    return img_np


def generate_image(digit):
    img = Image.new("L", (IMG_SIZE, IMG_SIZE), color=255)
    draw = ImageDraw.Draw(img)


    font_size = random.randint(30, 50)
    font = ImageFont.truetype(FONT_PATH, font_size)

    # 3ï¸âƒ£ éšæœºä½ç½®
    x = random.randint(5, 20)
    y = random.randint(0, 20)

    # 4ï¸âƒ£ å†™æ•°å­—
    draw.text((x, y), str(digit), font=font, fill=0)

    # 5ï¸âƒ£ éšæœºæ—‹è½¬
    angle = random.uniform(-10, 10)
    img = img.rotate(angle, fillcolor=255)

    # 6ï¸âƒ£ äº®åº¦å˜åŒ–
    enhancer = ImageEnhance.Brightness(img)
    img = enhancer.enhance(random.uniform(0.7, 1.3))

    # è½¬ OpenCV å¤„ç†
    img_np = np.array(img)

    # 7ï¸âƒ£ æ¨¡ç³Š
    if random.random() > 0.5:
        img_np = cv2.GaussianBlur(img_np, (3, 3), 0)

    # 8ï¸âƒ£ åŠ å™ªå£°
    if random.random() > 0.5:
        img_np = add_noise(img_np)

    return img_np


def main():
    print("ğŸ“¦ åˆ›å»ºæ–‡ä»¶å¤¹...")
    make_dirs()

    print("ğŸš€ å¼€å§‹ç”Ÿæˆæ•°æ®é›†...")
    for digit in range(10):
        print(f"ç”Ÿæˆæ•°å­— {digit} ...")

        # è®­ç»ƒé›†
        for i in range(TRAIN_PER_CLASS):
            img = generate_image(digit)
            cv2.imwrite(f"{SAVE_ROOT}/train/{digit}/{i}.png", img)

        # éªŒè¯é›†
        for i in range(VAL_PER_CLASS):
            img = generate_image(digit)
            cv2.imwrite(f"{SAVE_ROOT}/val/{digit}/{i}.png", img)

    print("âœ… æ•°æ®é›†ç”Ÿæˆå®Œæˆï¼")


if __name__ == "__main__":
    main()
